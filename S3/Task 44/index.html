<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task 44</title>

    <link rel="stylesheet" href="style.css">
    <script src="js/main.js"></script>

    <style>
        body,
        html{
            padding: 0;
            margin: 0;
            height: 100%;
            background-color: #fff;
        }

        #wrap {
            width: 100%;
            margin: 0 auto;
            margin-top: 20px;
            min-height: 100%;
        }

        #add {
            border: none;
            background-color: #2ecc71;
            border-radius: 3px;
            outline: none;
            padding: .4rem 1rem;
            margin-left: .6rem;
            font-size: 1rem;
            font-weight: 500;
            color: #fff;
            cursor: pointer;
            font-family: 'Open Sans', Helvetica, Tahoma, Arial, STXihei, "Microsoft YaHei", SimSun, Heiti, sans-serif;
            -webkit-appearance: none;
        }
        #add:hover {
            background-color: #58d68d;
        }
        #add:active {
            background-color: #27ad60;
            color: #ccc;
        }

        @keyframes loading {
            0% {
                border-radius: 0;
                background-color: #ccc;
                transform: rotate(0deg); }
            50% {
                border-radius: 50%;
                background-color: #4eba56;
                transform: rotate(180deg); }
            100% {
                border-radius: 1%;
                background-color: #ccc;
                transform: rotate(359deg); }
        }
    </style>

</head>
<body>

    <div id="wrap">
    </div>

    <div style="text-align: center;margin: 20% 0 5% 0">
        <input type="button" id="add" value="添加图片">
    </div>
<script>

    var index = 0;

    var wow = wowPhoto({
        wrap: '#wrap',
        col: 5
    });

    getImgs(index);

    document.querySelector('#add').addEventListener('click', function() {
        getImgs(++index);
    });

    function getImgs(index) {

        new Promise(function(resolve, reject) {

            document.querySelector('#wrap').innerHTML += '<div class="loading"></div>';

            var xhr = new XMLHttpRequest();

            xhr.open('get', 'http://geeku.work/ife/api/img.php?page=' + index, true);

            xhr.send(null);

            xhr.onreadystatechange = function() {
                if(xhr.readyState === 4) {
                    if(xhr.status == 200) {
                        resolve(xhr.responseText);
                    } else {
                        reject();
                    }
                }
            }

        }).then(function(val) {
            document.querySelector('.loading').remove();

            if(val == 'null') {
                var add = document.querySelector('#add');
                add.value = '暂无图片';
                add.setAttribute('disabled', 'disabled');
                add.style.backgroundColor = '#ccc';
                return;
            }

            var imgList = JSON.parse(val);
            console.log(imgList);

            for (var key in imgList) {
                imgList[key].src = 'http://geeku.work/ife/api/imgs/' + imgList[key].src;
                wow.add(imgList[key]);
            }

        });
    }


</script>

</body>
</html>